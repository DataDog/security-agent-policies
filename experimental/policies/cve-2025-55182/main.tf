terraform {
  required_providers {
    datadog = {
      source = "DataDog/datadog"
      version = "3.72.0"
    }
  }
}

variable "api_key" {
  description = "Datadog API Key"
}

variable "app_key" {
  description = "Datadog App Key"
}

variable "url" {
  description = "Datadog Url"
  default = "http://app.datadoghq.com"
}

provider "datadog" {
  api_key = var.api_key
  app_key = var.app_key
  api_url = var.url
}

resource "datadog_csm_threats_policy" "experimental_cve_2025_55182" {
    description  = "Detect CVE-2025-55182 Node.js RCE (experimental)"
    name         = "Detect CVE-2025-55182 Node.js RCE (experimental)"
    enabled      = false
}

resource "datadog_csm_threats_agent_rule" "experimental_cve_2025_55182_node_spawn" {
    description  = "Detect potential post-exploitation of CVE-2025-55182 by monitoring shell/utility executions spawned from Node.js processes"
    enabled      = true
    expression   = "(exec.file.path in [\"/bin/dash\", \"/usr/bin/dash\", \"/bin/sh\", \"/bin/static-sh\", \"/usr/bin/sh\", \"/bin/bash\", \"/usr/bin/bash\", \"/bin/bash-static\", \"/usr/bin/zsh\", \"/usr/bin/ash\", \"/usr/bin/csh\", \"/usr/bin/ksh\", \"/usr/bin/tcsh\", \"/usr/lib/initramfs-tools/bin/busybox\", \"/bin/busybox\", \"/usr/bin/fish\", \"/bin/ksh93\", \"/bin/rksh\", \"/bin/rksh93\", \"/bin/lksh\", \"/bin/mksh\", \"/bin/mksh-static\", \"/usr/bin/csharp\", \"/bin/posh\", \"/usr/bin/rc\", \"/bin/sash\", \"/usr/bin/yash\", \"/bin/zsh5\", \"/bin/zsh5-static\"] || exec.comm in [\"wget\", \"curl\", \"lwp-download\"] || exec.file.path in [\"/bin/cat\", \"/bin/chgrp\", \"/bin/chmod\", \"/bin/chown\", \"/bin/cp\", \"/bin/date\", \"/bin/dd\", \"/bin/df\", \"/bin/dir\", \"/bin/echo\", \"/bin/ln\", \"/bin/ls\", \"/bin/mkdir\", \"/bin/mknod\", \"/bin/mktemp\", \"/bin/mv\", \"/bin/pwd\", \"/bin/readlink\", \"/bin/rm\", \"/bin/rmdir\", \"/bin/sleep\", \"/bin/stty\", \"/bin/sync\", \"/bin/touch\", \"/bin/uname\", \"/bin/vdir\", \"/usr/bin/arch\", \"/usr/bin/b2sum\", \"/usr/bin/base32\", \"/usr/bin/base64\", \"/usr/bin/basename\", \"/usr/bin/chcon\", \"/usr/bin/cksum\", \"/usr/bin/comm\", \"/usr/bin/csplit\", \"/usr/bin/cut\", \"/usr/bin/dircolors\", \"/usr/bin/dirname\", \"/usr/bin/du\", \"/usr/bin/env\", \"/usr/bin/expand\", \"/usr/bin/expr\", \"/usr/bin/factor\", \"/usr/bin/fmt\", \"/usr/bin/fold\", \"/usr/bin/groups\", \"/usr/bin/head\", \"/usr/bin/hostid\", \"/usr/bin/id\", \"/usr/bin/install\", \"/usr/bin/join\", \"/usr/bin/link\", \"/usr/bin/logname\", \"/usr/bin/md5sum\", \"/usr/bin/md5sum.textutils\", \"/usr/bin/mkfifo\", \"/usr/bin/nice\", \"/usr/bin/nl\", \"/usr/bin/nohup\", \"/usr/bin/nproc\", \"/usr/bin/numfmt\", \"/usr/bin/od\", \"/usr/bin/paste\", \"/usr/bin/pathchk\", \"/usr/bin/pinky\", \"/usr/bin/pr\", \"/usr/bin/printenv\", \"/usr/bin/printf\", \"/usr/bin/ptx\", \"/usr/bin/realpath\", \"/usr/bin/runcon\", \"/usr/bin/seq\", \"/usr/bin/sha1sum\", \"/usr/bin/sha224sum\", \"/usr/bin/sha256sum\", \"/usr/bin/sha384sum\", \"/usr/bin/sha512sum\", \"/usr/bin/shred\", \"/usr/bin/shuf\", \"/usr/bin/sort\", \"/usr/bin/split\", \"/usr/bin/stat\", \"/usr/bin/stdbuf\", \"/usr/bin/sum\", \"/usr/bin/tac\", \"/usr/bin/tail\", \"/usr/bin/tee\", \"/usr/bin/test\", \"/usr/bin/timeout\", \"/usr/bin/tr\", \"/usr/bin/truncate\", \"/usr/bin/tsort\", \"/usr/bin/tty\", \"/usr/bin/unexpand\", \"/usr/bin/uniq\", \"/usr/bin/unlink\", \"/usr/bin/users\", \"/usr/bin/wc\", \"/usr/bin/who\", \"/usr/bin/whoami\", \"/usr/sbin/chroot\", \"/bin/busybox\"]) && process.parent.file.name == \"node\""
    name         = "experimental_cve_2025_55182_node_spawn"
    policy_id    = datadog_csm_threats_policy.experimental_cve_2025_55182.id
    product_tags = ["type:experimental"]
}

resource "datadog_security_monitoring_rule" "react2shell_exploited" {
    name = "Possible post-exploitation of React2Shell"
    enabled = true
    query {
        query = "@agent.rule_id:node_spawning_suspicious_child_process"
        group_by_fields = ["host"]
        has_optional_group_by_fields = false
        distinct_fields = []
        aggregation = "count"
        name = "node_shell"
        data_source = "security_runtime"
    }
    options {
        keep_alive = 3600
        max_signal_duration = 86400
        detection_method = "threshold"
        evaluation_window = 900
    }
    case {
        name = ""
        status = "critical"
        notifications = []
        condition = "node_shell > 0"
    }
    message = "Aims at identifying post-exploitation of React2Shell"
    tags = []
    has_extended_title = true
    type = "workload_security"
}

