# IMPORTANT: Edits to this file will not be reflected in the Datadog App and will be overwritten with new policy file downloads. Please modify rules in the Datadog App for full functionality.
version: 1.11.2
macros:
  - id: APP_PACKAGE_MANAGERS
    description: Package managers
    expression: '["pip3", "pip", "npm"]'
  - id: APT_PROCESSES
    expression: '["/usr/bin/unattended-upgrade", "/usr/bin/apt"]'
  - id: AWS_RISKY_URI
    description: AWS IMDS URI's known for exploitation
    expression: '[~"*169.254.169.254/latest/meta-data/iam/security-credentials/*", "*169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI", ~"*169.254.170.2/*/credentials?id=*"]'
  - id: AZURE_RISKY_URI
    description: Azure IMDS URI's known for exploitation
    expression: '[~"*169.254.169.254/metadata/identity/oauth2/token?api-version=*"]'
  - id: CHMOD_EXEC_FLAGS
    expression: S_IXUSR|S_IXGRP|S_IXOTH
  - id: COMMON_MODULES
    description: Common kernel modules
    expression: '["nf_tables", "iptable_filter", "ip6table_filter", "bpfilter", "ip6_tables", "ip6table_nat", "nf_reject_ipv4", "ipt_REJECT", "iptable_raw"]'
  - id: COMMON_TRACERS
    description: Common tracers
    expression: '["dlv", "dlv-linux-amd64", "strace", "gdb", "lldb-server"]'
  - id: COMPILER_PROCESSES
    expression: '["javac", "clang", "gcc","bcc"]'
  - id: CONTAINER_CLIENTS
    expression: '["docker", "kubectl"]'
  - id: CONTAINER_PROCESSES
    description: Processes related to operating containers and kubernetes clusters
    expression: |-
      ["/usr/bin/containerd", "/usr/local/bin/containerd",
       "/usr/bin/docker", "/usr/local/bin/docker",
       "/usr/bin/dockerd", "/usr/local/bin/dockerd",
       "/usr/bin/docker-compose", "/usr/local/bin/docker-compose",
       "/usr/bin/kubelet", "/usr/local/bin/kubelet",
       "/usr/bin/kubectl", "/usr/local/bin/kubectl",
       "/usr/bin/skydns", "/usr/local/bin/skydns",
       "/usr/bin/exechealthz", "/usr/local/bin/exechealthz",
       "/usr/bin/weave-net", "/usr/local/bin/weave-net",
       "/opt/cni/bin/loopback", "/opt/cni/bin/bridge"]
  - id: CREDENTIAL_BINARIES
    expression: '[ "/sbin/vipw", "/usr/sbin/vipw", "/sbin/vigr", "/usr/sbin/vigr", "/usr/bin/containerd", "/usr/local/bin/containerd", "/usr/bin/dockerd", "/usr/local/bin/dockerd", "/usr/sbin/groupadd", "/usr/sbin/useradd", "/usr/sbin/usermod", "/usr/sbin/userdel",
      "/usr/bin/gpasswd", "/usr/bin/chage", "/usr/sbin/chpasswd", "/usr/bin/passwd" ]'
  - id: CRYPTOMINER_DOMAINS
    expression: '[~"*minexmr.com", ~"*nanopool.org", ~"*supportxmr.com", ~"*c3pool.com", ~"*p2pool.io", ~"*ethermine.org", ~"*f2pool.com", ~"*poolin.me", ~"*rplant.xyz"]'
  - id: DATABASE_PROCESSES
    description: Common database process names
    expression: '["mysqld", "mongod", "postgres"]'
  - id: DD_AGENT_PROCESSES
    description: Processes that are a part of the Datadog Agent
    expression: '["/opt/datadog-agent/embedded/bin/agent", "/opt/datadog-agent/embedded/bin/system-probe", "/opt/datadog-agent/embedded/bin/security-agent", "/opt/datadog-agent/embedded/bin/process-agent", "/opt/datadog-agent/bin/agent/agent", "/opt/datadog/apm/inject/auto_inject_runc",
      "/usr/bin/dd-host-install", "/usr/bin/dd-host-container-install", "/usr/bin/dd-container-install", "/opt/datadog-agent/bin/datadog-cluster-agent"]'
  - id: FDB_SERVER_PROCESSES
    expression: '["/usr/sbin/fdbserver", "/usr/lib/foundationdb/backup_agent/backup_agent"]'
  - id: GCP_RISKY_URI
    description: GCP IMDS URI's known for exploitation
    expression: '[~"*metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token", ~"*169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token"]'
  - id: GITLAB_PROCESSES
    expression: '["/opt/gitlab/embedded/bin/bundle", "/opt/gitlab/embedded/bin/svlogd"]'
  - id: HTTP_UTILS
    description: Executables commonly used to fetch data over HTTP
    expression: '["wget", "curl", "lwp-download"]'
  - id: INTERPRETER_PROCESSES
    description: Processes associated with interpreted programming languages (Python, Node.js)
    expression: '[~"python2*", ~"python3*", "node", "perl", ~"ruby*"]'
  - id: IPCHECK_DOMAINS
    expression: '["icanhazip.com", "ip-api.com", "myip.opendns.com", "checkip.amazonaws.com", "whatismyip.akamai.com"]'
  - id: LIBC_VERSIONS
    description: LIBC Library Versions
    expression: '["libc-2.29.so", "libc-2.30.so", "libc-2.31.so", "libc-2.32.so", "libc-2.33.so", "libc-2.34.so", "libc-2.35.so", "libc-2.36.so", "libc-2.37.so"]'
  - id: NETWORK_SCANNERS
    description: Commonly used network scanners
    expression: '["nmap", "masscan", "fping", "zgrab", "zgrab2", "rustscan", "pnscan"]'
  - id: NET_UTILS
    description: Executables of common network utilites
    expression: '["socat", "dig", "nslookup", "host", ~"netcat*", ~"nc*", "ncat"]'
  - id: OPEN_CREATE_FLAGS
    expression: O_CREAT|O_RDWR|O_WRONLY
  - id: OPEN_WRITE_FLAGS
    expression: O_CREAT|O_TRUNC|O_RDWR|O_WRONLY
  - id: PACKAGE_MANAGERS
    description: Package managers and container runtimes
    expression: '[~"/usr/bin/apt*", "/usr/bin/dpkg", "/usr/bin/rpm", "/usr/bin/unattended-upgrade", "/usr/bin/npm", ~"/usr/bin/pip*", "/usr/bin/yum", "/sbin/apk", "/usr/lib/snapd/snapd"]'
  - id: PACKAGE_MANAGERS_AND_RUNTIMES
    description: Package managers and container runtimes
    expression: '[~"/usr/bin/apt*", "/usr/bin/dpkg", "/usr/bin/rpm", "/usr/bin/unattended-upgrade", "/usr/bin/containerd", "/usr/local/bin/containerd", "/usr/bin/dockerd", "/usr/bin/npm", ~"/usr/bin/pip*"]'
  - id: PASTE_SITES
    expression: '["pastebin.com", "ghostbin.com", "termbin.com", "klgrth.io"]'
  - id: SHELLS
    description: Common Linux shell executables
    expression: |-
      [ "/bin/dash",
        "/usr/bin/dash",
        "/bin/sh",
        "/bin/static-sh",
        "/usr/bin/sh",
        "/bin/bash",
        "/usr/bin/bash",
        "/bin/bash-static",
        "/usr/bin/zsh",
        "/usr/bin/ash",
        "/usr/bin/csh",
        "/usr/bin/ksh",
        "/usr/bin/tcsh",
        "/usr/lib/initramfs-tools/bin/busybox",
        "/bin/busybox",
        "/usr/bin/fish",
        "/bin/ksh93",
        "/bin/rksh",
        "/bin/rksh93",
        "/bin/lksh",
        "/bin/mksh",
        "/bin/mksh-static",
        "/usr/bin/csharp",
        "/bin/posh",
        "/usr/bin/rc",
        "/bin/sash",
        "/usr/bin/yash",
        "/bin/zsh5",
        "/bin/zsh5-static" ]
  - id: SHELL_UTILS
    description: Executables in the coreutils
    expression: '["/bin/cat","/bin/chgrp","/bin/chmod","/bin/chown","/bin/cp","/bin/date","/bin/dd","/bin/df","/bin/dir","/bin/echo","/bin/ln","/bin/ls","/bin/mkdir","/bin/mknod","/bin/mktemp","/bin/mv","/bin/pwd","/bin/readlink","/bin/rm","/bin/rmdir","/bin/sleep","/bin/stty","/bin/sync","/bin/touch","/bin/uname","/bin/vdir","/usr/bin/arch","/usr/bin/b2sum","/usr/bin/base32","/usr/bin/base64","/usr/bin/basename","/usr/bin/chcon","/usr/bin/cksum","/usr/bin/comm","/usr/bin/csplit","/usr/bin/cut","/usr/bin/dircolors","/usr/bin/dirname","/usr/bin/du","/usr/bin/env","/usr/bin/expand","/usr/bin/expr","/usr/bin/factor","/usr/bin/fmt","/usr/bin/fold","/usr/bin/groups","/usr/bin/head","/usr/bin/hostid","/usr/bin/id","/usr/bin/install","/usr/bin/join","/usr/bin/link","/usr/bin/logname","/usr/bin/md5sum","/usr/bin/md5sum.textutils","/usr/bin/mkfifo","/usr/bin/nice","/usr/bin/nl","/usr/bin/nohup","/usr/bin/nproc","/usr/bin/numfmt","/usr/bin/od","/usr/bin/paste","/usr/bin/pathchk","/usr/bin/pinky","/usr/bin/pr","/usr/bin/printenv","/usr/bin/printf","/usr/bin/ptx","/usr/bin/realpath","/usr/bin/runcon","/usr/bin/seq","/usr/bin/sha1sum","/usr/bin/sha224sum","/usr/bin/sha256sum","/usr/bin/sha384sum","/usr/bin/sha512sum","/usr/bin/shred","/usr/bin/shuf","/usr/bin/sort","/usr/bin/split","/usr/bin/stat","/usr/bin/stdbuf","/usr/bin/sum","/usr/bin/tac","/usr/bin/tail","/usr/bin/tee","/usr/bin/test","/usr/bin/timeout","/usr/bin/tr","/usr/bin/truncate","/usr/bin/tsort","/usr/bin/tty","/usr/bin/unexpand","/usr/bin/uniq","/usr/bin/unlink","/usr/bin/users","/usr/bin/wc","/usr/bin/who","/usr/bin/whoami","/usr/sbin/chroot"]'
  - id: SYSTEMD_FOLDERS
    description: Package managers
    expression: '[ ~"/lib/systemd/system/**", ~"/usr/lib/systemd/system/**", ~"/etc/systemd/system/**" ]'
  - id: SYSTEMD_JOURNALD_PROCESSES
    expression: '["/usr/lib/systemd/systemd-journald"]'
  - id: SYSTEM_PACKAGE_MANAGERS
    description: Package managers
    expression: '["/usr/bin/apt", "/usr/bin/apt-get", "/usr/bin/apt-config", "/usr/bin/dpkg", "/usr/bin/aptitude-curses", "/usr/bin/rpm", "/usr/bin/unattended-upgrade", "/sbin/apk"]'
  - id: WEBAPP_PROCESSES
    description: Processes that commonly run web applications
    expression: '["apache2", "nginx", ~"tomcat*", "httpd"]'
rules:
  - id: apparmor_modified_tty
    description: An AppArmor profile was modified in an interactive session
    expression: exec.file.name in ["aa-disable", "aa-complain", "aa-audit"] && exec.tty_name !=""
  - id: auditctl_usage
    description: The auditctl command was used to modify auditd
    expression: exec.file.name == "auditctl"
  - id: auditd_config_modified
    description: The auditd configuration file was modified without using auditctl
    expression: open.file.path == "/etc/audit/auditd.conf" && open.flags & (OPEN_WRITE_FLAGS) > 0 && process.file.name != "auditctl"
  - id: auditd_rule_file_modified
    description: The auditd rules file was modified without using auditctl
    expression: open.file.path in ["/etc/audit/rules.d/audit.rules", "/etc/audit/audit.rules"] && open.flags & (OPEN_WRITE_FLAGS) > 0 && process.file.name != "auditctl"
  - id: aws_eks_service_account_token_accessed
    description: The AWS EKS service account token was accessed
    expression: open.file.path =~ "/var/run/secrets/eks.amazonaws.com/serviceaccount/**" && open.file.name == "token" && process.file.path not in DD_AGENT_PROCESSES
    tags:
      threat_score: '4'
      threat_description: Access to privileged Service Account tokens could allow impersonation to the EKS control plane.
  - id: aws_imds
    description: An AWS IMDS was called via a network utility
    expression: exec.comm in HTTP_UTILS && exec.args in AWS_RISKY_URI
  - id: aws_metadata_service
    description: The EC2 instance metadata service was called via a network utility using an interactive session
    expression: exec.comm in HTTP_UTILS && exec.args in [~"*169.254.169.254*"] && exec.tty_name != ""
  - id: azure_imds
    description: An Azure IMDS was called via a network utility
    expression: exec.comm in HTTP_UTILS && exec.args in AZURE_RISKY_URI
  - id: base64_decode
    description: The base64 command was used to decode information
    expression: exec.file.name == "base64" && exec.args_flags in ["d"]
  - id: common_net_intrusion_util
    description: A network utility (nmap) commonly used in intrusion attacks was executed
    expression: exec.file.name in NETWORK_SCANNERS && exec.args_flags not in ["V", "version"]
    tags:
      threat_score: '7'
      threat_description: Network scanners are used to discover additional infrastructure after compromise
  - id: compile_after_delivery
    description: A compiler wrote a suspicious file in a container
    expression: |-
      open.flags & O_CREAT > 0
      && (
        (open.file.path =~ "/tmp/**" && open.file.name in [~"*.ko", ~".*"])
        || open.file.path in [~"/var/tmp/**", ~"/dev/shm/**", ~"/root/**", ~"*/bin/*", ~"/usr/local/lib/**"]
      )
      && (process.comm in COMPILER_PROCESSES || process.ancestors.comm in COMPILER_PROCESSES)
      && process.file.name not in ["pip", ~"python*"]
      && container.id != ""
    tags:
      threat_score: '8'
      threat_description: Malicious code may be downloaded and compiled on the workload to evade detection
  - id: compiler_in_container
    description: A compiler was executed inside of a container
    expression: (exec.file.name in COMPILER_PROCESSES || (exec.file.name == "go" && exec.args in [~"*build*", ~"*run*"])) && container.id !="" && process.ancestors.file.path != "/usr/bin/cilium-agent"
  - id: credential_modified_chmod
    description: Sensitive credential files were modified using a non-standard tool
    expression: |-
      (
          (chmod.file.path in [ "/etc/shadow", "/etc/gshadow" ])
          && process.file.path not in CREDENTIAL_BINARIES
          && process.ancestors.file.path not in PACKAGE_MANAGERS
      ) && chmod.file.destination.mode != chmod.file.mode
    tags:
      threat_score: '5'
      threat_description: Credentials should be static or defined as code. Changes to credentials files indicates drift.
  - id: credential_modified_chown
    description: Sensitive credential files were modified using a non-standard tool
    expression: |-
      (
          (chown.file.path in [ "/etc/shadow", "/etc/gshadow" ])
          && process.file.path not in CREDENTIAL_BINARIES
          && process.ancestors.file.path not in PACKAGE_MANAGERS
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
    tags:
      threat_score: '5'
      threat_description: Credentials should be static or defined as code. Changes to credentials files indicates drift.
  - id: credential_modified_link
    description: Sensitive credential files were modified using a non-standard tool
    expression: |-
      (
          (link.file.path in [ "/etc/shadow", "/etc/gshadow" ]
          || link.file.destination.path in [ "/etc/shadow", "/etc/gshadow" ])
          && process.file.path not in CREDENTIAL_BINARIES
          && process.ancestors.file.path not in PACKAGE_MANAGERS
      )
    tags:
      threat_score: '5'
      threat_description: Credentials should be static or defined as code. Changes to credentials files indicates drift.
  - id: credential_modified_open
    description: Sensitive credential files were modified using a non-standard tool
    expression: |-
      (
          open.flags & ((O_CREAT|O_RDWR|O_WRONLY|O_TRUNC)) > 0 &&
          (open.file.path in [ "/etc/shadow", "/etc/gshadow" ])
          && process.file.path not in CREDENTIAL_BINARIES
          && process.ancestors.file.path not in PACKAGE_MANAGERS
      )
    tags:
      threat_score: '5'
      threat_description: Credentials should be static or defined as code. Changes to credentials files indicates drift.
  - id: credential_modified_rename
    description: Sensitive credential files were modified using a non-standard tool
    expression: |-
      (
          (rename.file.path in [ "/etc/shadow", "/etc/gshadow" ]
          || rename.file.destination.path in [ "/etc/shadow", "/etc/gshadow" ])
          && process.file.path not in CREDENTIAL_BINARIES
          && process.ancestors.file.path not in PACKAGE_MANAGERS
      )
    tags:
      threat_score: '5'
      threat_description: Credentials should be static or defined as code. Changes to credentials files indicates drift.
  - id: credential_modified_unlink
    description: Sensitive credential files were modified using a non-standard tool
    expression: |-
      (
          (unlink.file.path in [ "/etc/shadow", "/etc/gshadow" ])
          && process.file.path not in CREDENTIAL_BINARIES
          && process.ancestors.file.path not in PACKAGE_MANAGERS
      )
    tags:
      threat_score: '5'
      threat_description: Credentials should be static or defined as code. Changes to credentials files indicates drift.
  - id: credential_modified_utimes
    description: Sensitive credential files were modified using a non-standard tool
    expression: |-
      (
          (utimes.file.path in [ "/etc/shadow", "/etc/gshadow" ])
          && process.file.path not in CREDENTIAL_BINARIES
          && process.ancestors.file.path not in PACKAGE_MANAGERS
      )
    tags:
      threat_score: '5'
      threat_description: Credentials should be static or defined as code. Changes to credentials files indicates drift.
  - id: cron_at_job_creation_chmod
    description: An unauthorized job was added to cron scheduling
    expression: |-
      (
          (chmod.file.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ])
          && process.file.path not in [ "/usr/bin/at", "/usr/bin/crontab" ]
      ) && chmod.file.destination.mode != chmod.file.mode
      && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
  - id: cron_at_job_creation_chown
    description: An unauthorized job was added to cron scheduling
    expression: |-
      (
          (chown.file.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ])
          && process.file.path not in [ "/usr/bin/at", "/usr/bin/crontab" ]
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
      && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
  - id: cron_at_job_creation_link
    description: An unauthorized job was added to cron scheduling
    expression: |-
      (
          (link.file.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ]
          || link.file.destination.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ])
          && process.file.path not in [ "/usr/bin/at", "/usr/bin/crontab" ]
      )
      && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
  - id: cron_at_job_creation_open
    description: An unauthorized job was added to cron scheduling
    expression: |-
      (
          open.flags & (OPEN_CREATE_FLAGS) > 0 &&
          (open.file.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ])
          && process.file.path not in [ "/usr/bin/at", "/usr/bin/crontab" ]
      )
      && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
  - id: cron_at_job_creation_rename
    description: An unauthorized job was added to cron scheduling
    expression: |-
      (
          (rename.file.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ]
          || rename.file.destination.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ])
          && process.file.path not in [ "/usr/bin/at", "/usr/bin/crontab" ]
      )
      && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
  - id: cron_at_job_creation_unlink
    description: An unauthorized job was added to cron scheduling
    expression: |-
      (
          (unlink.file.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ])
          && process.file.path not in [ "/usr/bin/at", "/usr/bin/crontab" ]
      )
      && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
  - id: cron_at_job_creation_utimes
    description: An unauthorized job was added to cron scheduling
    expression: |-
      (
          (utimes.file.path in [ ~"/var/spool/cron/**", ~"/etc/cron.*/**", ~"/etc/crontab" ])
          && process.file.path not in [ "/usr/bin/at", "/usr/bin/crontab" ]
      )
      && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
  - id: cryptominer_args
    description: A process launched with arguments associated with cryptominers
    expression: exec.args_options in [~"cpu-priority*", ~"donate-level*"] || exec.args in [~"*stratum+tcp*"]
    tags:
      threat_score: '9'
      threat_description: Cloud environments are a common target for cryptocurrency mining
  - id: database_shell_execution
    description: A database application spawned a shell, shell utility, or HTTP utility
    expression: |-
      (exec.file.path in SHELLS ||
       exec.comm in HTTP_UTILS ||
       exec.file.path in SHELL_UTILS) &&
      process.ancestors.file.name in DATABASE_PROCESSES &&
      !(process.ancestors.file.name == "initdb" &&
      exec.args == "-c locale -a") &&
      !(process.ancestors.file.name == "postgres" &&
      exec.args == ~"*pg_wal*")
  - id: dirty_pipe_attempt
    description: Potential Dirty pipe exploitation attempt
    expression: (splice.pipe_entry_flag & PIPE_BUF_FLAG_CAN_MERGE) != 0 && (splice.pipe_exit_flag & PIPE_BUF_FLAG_CAN_MERGE) == 0 && (process.uid != 0 && process.gid != 0)
    tags:
      threat_score: '8'
      threat_description: The vulnerability CVE-2022-0847 allows privilege escalation using pipes
  - id: dirty_pipe_exploitation
    description: Potential Dirty pipe exploitation
    expression: (splice.pipe_exit_flag & PIPE_BUF_FLAG_CAN_MERGE) > 0  && (process.uid != 0 && process.gid != 0)
    tags:
      threat_score: '7'
      threat_description: The vulnerability CVE-2022-0847 allows privilege escalation using pipes
  - id: dynamic_linker_config_unlink
    description: A process unlinked a dynamic linker config file
    expression: unlink.file.path in ["/etc/ld.so.preload", "/etc/ld.so.conf", ~"/etc/ld.so.conf.d/*.conf"] && process.file.path not in PACKAGE_MANAGERS
    tags:
      threat_score: '8'
      threat_description: Malicious payloads can be executed by removing and replacing global configurations the dynamic linker uses to load shared libraries.
  - id: dynamic_linker_config_write
    description: A process wrote to a dynamic linker config file
    expression: open.file.path in ["/etc/ld.so.preload", "/etc/ld.so.conf", "/etc/ld.so.conf.d/*.conf"] && open.flags & (OPEN_WRITE_FLAGS) > 0 && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES && process.ancestors.file.path not in DD_AGENT_PROCESSES
    tags:
      threat_score: '8'
      threat_description: Malicious payloads can be executed by hijacking global configurations the dynamic linker uses to load shared libraries.
  - id: executable_bit_added
    description: The executable bit was added to a newly created file
    expression: |-
      chmod.file.in_upper_layer &&
      chmod.file.change_time < 30s &&
      container.id != "" &&
      chmod.file.destination.mode != chmod.file.mode &&
      chmod.file.destination.mode & CHMOD_EXEC_FLAGS > 0 &&
      process.argv in ["+x"]
  - id: gcp_imds
    description: An GCP IMDS was called via a network utility
    expression: exec.comm in HTTP_UTILS && exec.args in GCP_RISKY_URI
  - id: interactive_shell_in_container
    description: An interactive shell was started inside of a container
    expression: exec.file.path in SHELLS && exec.args_flags in ["i"] && container.id !=""
  - id: ip_check_domain
    description: A DNS lookup was done for a IP check service
    expression: dns.question.name in IPCHECK_DOMAINS && process.file.name != ""
  - id: java_shell_execution
    description: A java process spawned a shell, shell utility, or HTTP utility
    expression: |-
      (exec.file.path in SHELLS ||
       exec.comm in HTTP_UTILS ||
       exec.file.path in SHELL_UTILS)
      && process.ancestors.file.name == "java"
    tags:
      threat_score: '4'
      threat_description: Java executing shell commands may indicate remote code execution (RCE)
  - id: java_shell_execution_parent
    description: A java process spawned a shell, shell utility, or HTTP utility
    expression: |-
      (exec.file.path in SHELLS ||
       exec.comm in HTTP_UTILS ||
       exec.file.path in SHELL_UTILS)
      && process.parent.file.name == "java"
    tags:
      threat_score: '4'
      threat_description: Java executing shell commands may indicate remote code execution (RCE)
  - id: k8s_pod_service_account_token_accessed
    description: The Kubernetes pod service account token was accessed
    expression: open.file.path in [~"/var/run/secrets/kubernetes.io/serviceaccount/**", ~"/run/secrets/kubernetes.io/serviceaccount/**"] && open.file.name == "token" && process.file.path not in DD_AGENT_PROCESSES && process.file.path not in  ["/usr/bin/cilium-agent",
      "/coredns", "/usr/bin/cilium-operator"]
    tags:
      threat_score: '4'
      threat_description: Access to privileged Service Account tokens could allow impersonation to the Kubernetes control plane.
  - id: kernel_module_chmod
    description: A new kernel module was added
    expression: |-
      (
          (chmod.file.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ])
          && process.file.path not in PACKAGE_MANAGERS
          && process.ancestors.file.path not in PACKAGE_MANAGERS && process.ancestors.file.path != "/usr/bin/kmod"
      ) && chmod.file.destination.mode != chmod.file.mode
  - id: kernel_module_chown
    description: A new kernel module was added
    expression: |-
      (
          (chown.file.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ])
          && process.file.path not in PACKAGE_MANAGERS
          && process.ancestors.file.path not in PACKAGE_MANAGERS && process.ancestors.file.path != "/usr/bin/kmod"
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
  - id: kernel_module_link
    description: A new kernel module was added
    expression: |-
      (
          (link.file.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ]
          || link.file.destination.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ])
          && process.file.path not in PACKAGE_MANAGERS
          && process.ancestors.file.path not in PACKAGE_MANAGERS && process.ancestors.file.path != "/usr/bin/kmod"
      )
  - id: kernel_module_load
    description: A kernel module was loaded
    expression: load_module.name not in COMMON_MODULES && process.ancestors.file.name not in [~"falcon*", "unattended-upgrade", "apt.systemd.daily", "xtables-legacy-multi", "ssm-agent-worker"]
  - id: kernel_module_load_container
    description: A container loaded a new kernel module
    expression: load_module.name != "" && container.id !=""
  - id: kernel_module_load_from_memory
    description: A kernel module was loaded from memory
    expression: load_module.loaded_from_memory == true
    tags:
      threat_score: '4'
      threat_description: Malicious kernel modules may establish persistence or hide activity
  - id: kernel_module_load_from_memory_container
    description: A kernel module was loaded from memory inside a container
    expression: load_module.loaded_from_memory == true && container.id !=""
    tags:
      threat_score: '4'
      threat_description: Malicious kernel modules may establish persistence or hide activity
  - id: kernel_module_open
    description: A new kernel module was added
    expression: |-
      (
          open.flags & (OPEN_WRITE_FLAGS) > 0 &&
          (open.file.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ])
          && process.file.path not in PACKAGE_MANAGERS
          && process.ancestors.file.path not in PACKAGE_MANAGERS && process.ancestors.file.path != "/usr/bin/kmod"
      )
  - id: kernel_module_rename
    description: A new kernel module was added
    expression: |-
      (
          (rename.file.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ]
          || rename.file.destination.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ])
          && process.file.path not in PACKAGE_MANAGERS
          && process.ancestors.file.path not in PACKAGE_MANAGERS && process.ancestors.file.path != "/usr/bin/kmod"
      )
  - id: kernel_module_unlink
    description: A new kernel module was added
    expression: |-
      (
          (unlink.file.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ])
          && process.file.path not in PACKAGE_MANAGERS
          && process.ancestors.file.path not in PACKAGE_MANAGERS && process.ancestors.file.path != "/usr/bin/kmod"
      )
  - id: kernel_module_utimes
    description: A new kernel module was added
    expression: |-
      (
          (utimes.file.path in [ ~"/lib/modules/**", ~"/usr/lib/modules/**" ])
          && process.file.path not in PACKAGE_MANAGERS
          && process.ancestors.file.path not in PACKAGE_MANAGERS && process.ancestors.file.path != "/usr/bin/kmod"
      )
  - id: kubernetes_dns_enumeration
    description: Kubernetes DNS enumeration
    expression: dns.question.name == "any.any.svc.cluster.local" && dns.question.type == SRV && container.id != ""
  - id: ld_preload_unusual_library_path
    description: The LD_PRELOAD variable is populated by a link to a suspicious file directory
    expression: exec.envs in [~"LD_PRELOAD=*/tmp/*" ,~"LD_PRELOAD=/dev/shm/*" ]
    tags:
      threat_score: '8'
      threat_description: Malicious payloads can be executed by hijacking environment variables the dynamic linker uses to load shared libraries.
  - id: memfd_create
    description: memfd object created
    expression: exec.file.name =~ "memfd*" && exec.file.path == ""
  - id: mount_host_fs
    description: The host file system was mounted in a container
    expression: mount.source.path == "/" && mount.fs_type != "overlay" && container.id != ""
  - id: net_file_download
    description: A suspicious file was written by a network utility
    expression: |-
      open.flags & O_CREAT > 0 && process.comm in HTTP_UTILS
      && (
        (open.file.path =~ "/tmp/**" && open.file.name in [~"*.sh", ~"*.c", ~"*.so", ~"*.ko"])
        || open.file.path in [~"/usr/**", ~"/lib/**", ~"/etc/**", ~"/var/tmp/**", ~"/dev/shm/**"]
      )
  - id: net_unusual_request
    description: Network utility executed with suspicious URI
    expression: 'exec.comm in HTTP_UTILS && exec.args in [~"*.php*", ~"*.jpg*"] '
  - id: net_util
    description: A network utility was executed
    expression: |-
      (exec.comm in NET_UTILS ||
       exec.comm in HTTP_UTILS) &&
      container.id == "" && exec.args not in [ ~"*localhost*", ~"*127.0.0.1*", ~"*motd.ubuntu.com*" ]
  - id: net_util_exfiltration
    description: Exfiltration attempt via network utility
    expression: "exec.comm in HTTP_UTILS && \nexec.args_options in [ ~\"post-file=*\", ~\"post-data=*\", ~\"T=*\", ~\"d=@*\", ~\"upload-file=*\", ~\"F=file*\"] &&\nexec.args not in [~\"*localhost*\", ~\"*127.0.0.1*\"]"
  - id: net_util_in_container
    description: A network utility was executed in a container
    expression: |-
      (exec.comm in NET_UTILS ||
       exec.comm in HTTP_UTILS) &&
      container.id != "" && exec.args not in [ ~"*localhost*", ~"*127.0.0.1*", ~"*motd.ubuntu.com*" ]
  - id: new_binary_execution_in_container
    description: A container executed a new binary not found in the container image
    expression: container.id != "" && process.file.in_upper_layer && process.file.modification_time < 30s && exec.file.name != ""
    tags:
      threat_score: '4'
      threat_description: Container images should be immutable. New executables may be downloaded or compiled malware.
  - id: nsswitch_conf_mod_chmod
    description: nsswitch may have been modified without authorization
    expression: |-
      (
          (chmod.file.path in [ "/etc/nsswitch.conf" ])
      ) && chmod.file.destination.mode != chmod.file.mode
  - id: nsswitch_conf_mod_chown
    description: nsswitch may have been modified without authorization
    expression: |-
      (
          (chown.file.path in [ "/etc/nsswitch.conf" ])
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
  - id: nsswitch_conf_mod_link
    description: nsswitch may have been modified without authorization
    expression: |-
      (
          (link.file.path in [ "/etc/nsswitch.conf" ]
          || link.file.destination.path in [ "/etc/nsswitch.conf" ])
      )
  - id: nsswitch_conf_mod_open
    description: nsswitch may have been modified without authorization
    expression: |-
      (
          open.flags & ((O_RDWR|O_WRONLY|O_CREAT)) > 0 &&
          (open.file.path in [ "/etc/nsswitch.conf" ])
      )
  - id: nsswitch_conf_mod_rename
    description: nsswitch may have been modified without authorization
    expression: |-
      (
          (rename.file.path in [ "/etc/nsswitch.conf" ]
          || rename.file.destination.path in [ "/etc/nsswitch.conf" ])
      )
  - id: nsswitch_conf_mod_unlink
    description: nsswitch may have been modified without authorization
    expression: |-
      (
          (unlink.file.path in [ "/etc/nsswitch.conf" ])
      )
  - id: nsswitch_conf_mod_utimes
    description: nsswitch may have been modified without authorization
    expression: |-
      (
          (utimes.file.path in [ "/etc/nsswitch.conf" ])
      )
  - id: omigod
    description: Omiagent spawns a privileged child process
    expression: exec.uid >= 0 && process.ancestors.file.name == "omiagent"
  - id: package_management_in_container
    description: Package management was detected in a container
    expression: exec.file.path in PACKAGE_MANAGERS && container.id != ""
  - id: pam_modification_chmod
    description: PAM may have been modified without authorization
    expression: |-
      (
          (chmod.file.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ])
      ) && chmod.file.destination.mode != chmod.file.mode
  - id: pam_modification_chown
    description: PAM may have been modified without authorization
    expression: |-
      (
          (chown.file.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ])
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
  - id: pam_modification_link
    description: PAM may have been modified without authorization
    expression: |-
      (
          (link.file.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ]
          || link.file.destination.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ])
      )
  - id: pam_modification_open
    description: PAM may have been modified without authorization
    expression: |-
      (
          open.flags & (OPEN_WRITE_FLAGS) > 0 &&
          (open.file.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ])
      )
  - id: pam_modification_rename
    description: PAM may have been modified without authorization
    expression: |-
      (
          (rename.file.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ]
          || rename.file.destination.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ])
      )
  - id: pam_modification_unlink
    description: PAM may have been modified without authorization
    expression: |-
      (
          (unlink.file.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ])
      )
  - id: pam_modification_utimes
    description: PAM may have been modified without authorization
    expression: |-
      (
          (utimes.file.path in [ ~"/etc/pam.d/**", "/etc/pam.conf" ])
      ) && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
  - id: passwd_execution
    description: The passwd or chpasswd utility was used to modify an account password
    expression: exec.file.path in ["/usr/bin/passwd", "/usr/sbin/chpasswd"] && exec.args_flags not in ["S", "status"]
    tags:
      threat_score: '6'
      threat_description: Changing a password may be done to establish persistence
  - id: paste_site
    description: A DNS lookup was done for a pastebin-like site
    expression: dns.question.name in PASTE_SITES && process.file.name != ""
  - id: pci_11_5_critical_binaries_chmod
    description: Critical system binaries may have been modified
    expression: |-
      (
          (chmod.file.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ])
          && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
          && process.ancestors.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
      ) && chmod.file.destination.mode != chmod.file.mode
  - id: pci_11_5_critical_binaries_chown
    description: Critical system binaries may have been modified
    expression: |-
      (
          (chown.file.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ])
          && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
          && process.ancestors.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
  - id: pci_11_5_critical_binaries_link
    description: Critical system binaries may have been modified
    expression: |-
      (
          (link.file.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ]
          || link.file.destination.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ])
          && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
          && process.ancestors.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
      )
  - id: pci_11_5_critical_binaries_open
    description: Critical system binaries may have been modified
    expression: |-
      (
          open.flags & (OPEN_WRITE_FLAGS) > 0 &&
          open.file.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ]
          && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
          && process.ancestors.file.path not in PACKAGE_MANAGERS
      )
  - id: pci_11_5_critical_binaries_rename
    description: Critical system binaries may have been modified
    expression: |-
      (
          (rename.file.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ]
          || rename.file.destination.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ])
          && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
          && process.ancestors.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
      )
  - id: pci_11_5_critical_binaries_unlink
    description: Critical system binaries may have been modified
    expression: |-
      (
          (unlink.file.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ])
          && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
          && process.ancestors.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
      )
  - id: pci_11_5_critical_binaries_utimes
    description: Critical system binaries may have been modified
    expression: |-
      (
          (utimes.file.path in [ ~"/bin/*", ~"/sbin/*", ~"/usr/bin/*", ~"/usr/sbin/*", ~"/usr/local/bin/*", ~"/usr/local/sbin/*", ~"/boot/**" ])
          && process.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
          && process.ancestors.file.path not in PACKAGE_MANAGERS_AND_RUNTIMES
      )
  - id: potential_cryptominer
    description: A process resolved a DNS name associated with cryptomining activity
    expression: dns.question.name in CRYPTOMINER_DOMAINS && process.file.name != ""
    tags:
      threat_score: '8'
      threat_description: Cloud environments are a common target for cryptocurrency mining
  - id: potential_web_shell
    description: A web application spawned a shell or shell utility
    expression: |-
      (exec.file.path in SHELLS || exec.comm in HTTP_UTILS || exec.file.path in SHELL_UTILS) &&
      (process.ancestors.file.name in WEBAPP_PROCESSES || process.ancestors.file.name =~ "php*")
  - id: potential_web_shell_parent
    description: A web application spawned a shell or shell utility
    expression: |-
      (exec.file.path in SHELLS || exec.comm in HTTP_UTILS || exec.file.path in SHELL_UTILS) &&
      (process.parent.file.name in WEBAPP_PROCESSES || process.parent.file.name =~ "php*")
  - id: ptrace_antidebug
    description: A process uses an anti-debugging technique to block debuggers
    expression: ptrace.request == PTRACE_TRACEME && process.file.name != ""
    tags:
      threat_score: '7'
      threat_description: Anti-Debugging attempts from an process may suggest malware.
  - id: ptrace_injection
    description: A process attempted to inject code into another process
    expression: ptrace.request == PTRACE_POKETEXT || ptrace.request == PTRACE_POKEDATA || ptrace.request == PTRACE_POKEUSR
    tags:
      threat_score: '7'
      threat_description: Process injection may indicate an attempt to conceal malicious activity within benign operating system activity.
  - id: pwnkit_privilege_escalation
    description: A process was spawned with indicators of exploitation of CVE-2021-4034
    expression: (exec.file.path == "/usr/bin/pkexec" && exec.envs in [~"*SHELL*", ~"*PATH*"] && exec.envs not in [~"*DISPLAY*", ~"*DESKTOP_SESSION*"] && exec.uid != 0)
    tags:
      threat_score: '9'
      threat_description: The vulnerability CVE-2021-4034 allows privilege escalation using the pkexec utility
  - id: python_cli_code
    description: Python code was provided on the command line
    expression: exec.file.name == ~"python*" && exec.args_flags in ["c"] && exec.args in [~"*-c*SOCK_STREAM*", ~"*-c*subprocess*", "*-c*/bash*", "*-c*/bin/sh*", "*-c*pty.spawn*"]
    tags:
      threat_score: '8'
      threat_description: Some Python packages are associated with malicious behavior, especially when code is provided as a command-line argument.
  - id: redis_sandbox_escape
    description: Detects CVE-2022-0543
    expression: (open.file.path =~ "/usr/lib/x86_64-linux-gnu/*" && open.file.name in LIBC_VERSIONS) && process.ancestors.comm in ["redis-check-rdb", "redis-server"]
  - id: runc_modification
    description: The runc binary was modified in a non-standard way
    expression: |-
      open.file.path in ["/usr/bin/runc", "/usr/sbin/runc", "/usr/bin/docker-runc"]
      && open.flags & OPEN_WRITE_FLAGS > 0
      && process.file.path not in PACKAGE_MANAGERS
      && process.ancestors.file.path not in PACKAGE_MANAGERS
  - id: selinux_disable_enforcement
    description: SELinux enforcement status was disabled
    expression: selinux.enforce.status in ["permissive", "disabled"]
  - id: shell_history_deleted
    description: Shell History was Deleted
    expression: (unlink.file.name  =~ r".([dbazfi]*sh)(_history)$") && process.comm not in  ["dockerd", "containerd"]
  - id: shell_history_symlink
    description: A symbolic link for shell history was created targeting /dev/null
    expression: exec.comm == "ln" && exec.args in [~"*.*history*", "/dev/null"]
  - id: shell_history_truncated
    description: Shell History was Deleted
    expression: open.flags & (OPEN_WRITE_FLAGS) > 0 && open.file.name =~ r".([dbazfi]*sh)(_history)$" && open.file.path in [~"/root/*", ~"/home/**"] && process.file.name == "truncate"
  - id: ssh_authorized_keys_chmod
    description: SSH modified keys may have been modified
    expression: |-
      (
          chmod.file.name in [ "authorized_keys", "authorized_keys2" ] && (chmod.file.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ])
      ) && chmod.file.destination.mode != chmod.file.mode
  - id: ssh_authorized_keys_chown
    description: SSH modified keys may have been modified
    expression: |-
      (
          chown.file.name in [ "authorized_keys", "authorized_keys2" ] && (chown.file.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ])
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
  - id: ssh_authorized_keys_link
    description: SSH modified keys may have been modified
    expression: |-
      (
          link.file.name in [ "authorized_keys", "authorized_keys2" ] && (link.file.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ]
          || link.file.destination.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ])
      )
  - id: ssh_authorized_keys_open
    description: SSH modified keys may have been modified
    expression: |-
      (
          open.flags & (OPEN_WRITE_FLAGS) > 0 &&
          open.file.name in [ "authorized_keys", "authorized_keys2" ] && (open.file.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ])
      )
  - id: ssh_authorized_keys_rename
    description: SSH modified keys may have been modified
    expression: |-
      (
          rename.file.name in [ "authorized_keys", "authorized_keys2" ] && (rename.file.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ]
          || rename.file.destination.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ])
      )
  - id: ssh_authorized_keys_unlink
    description: SSH modified keys may have been modified
    expression: |-
      (
          unlink.file.name in [ "authorized_keys", "authorized_keys2" ] && (unlink.file.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ])
      )
  - id: ssh_authorized_keys_utimes
    description: SSH modified keys may have been modified
    expression: |-
      (
          utimes.file.name in [ "authorized_keys", "authorized_keys2" ] && (utimes.file.path in [ ~"/root/.ssh/*", ~"/home/*/.ssh/*", ~"/var/lib/*/.ssh/*" ])
      )
  - id: ssl_certificate_tampering_chmod
    description: SSL certificates may have been tampered with
    expression: |-
      (
          (chmod.file.path in [ ~"/etc/ssl/certs/**", ~"/etc/pki/**" ])
          && process.file.path not in PACKAGE_MANAGERS
      ) && chmod.file.mode != chmod.file.destination.mode
      && process.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path not in PACKAGE_MANAGERS
      && process.file.name !~ "runc*"
  - id: ssl_certificate_tampering_chown
    description: SSL certificates may have been tampered with
    expression: |-
      (
          (chown.file.path in [ ~"/etc/ssl/certs/**", ~"/etc/pki/**" ])
          && process.file.path not in PACKAGE_MANAGERS
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
      && process.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path not in PACKAGE_MANAGERS
      && process.file.name !~ "runc*"
  - id: ssl_certificate_tampering_link
    description: SSL certificates may have been tampered with
    expression: |-
      (
          (link.file.path in [ ~"/etc/ssl/certs/**", ~"/etc/pki/**" ]
          || link.file.destination.path in [ ~"/etc/ssl/certs/**", ~"/etc/pki/**" ])
          && process.file.path not in PACKAGE_MANAGERS
          && process.file.path != "/usr/sbin/update-ca-certificates"
          && process.ancestors.file.path != "/usr/sbin/update-ca-certificates"
          && process.ancestors.file.path not in PACKAGE_MANAGERS
          && process.file.name !~ "runc*"
      )
  - id: ssl_certificate_tampering_open
    description: SSL certificates may have been tampered with
    expression: |-
      (
          open.flags & (OPEN_CREATE_FLAGS) > 0 &&
          (open.file.path in [ ~"/etc/ssl/certs/**", ~"/etc/pki/**" ])
      )
      && process.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path not in PACKAGE_MANAGERS
      && process.file.name !~ "runc*"
  - id: ssl_certificate_tampering_rename
    description: SSL certificates may have been tampered with
    expression: |-
      (
          (rename.file.path in [ ~"/etc/ssl/certs/**", ~"/etc/pki/**" ]
          || rename.file.destination.path in [ ~"/etc/ssl/certs/**", ~"/etc/pki/**" ])
          && process.file.path not in PACKAGE_MANAGERS
      )
      && process.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path not in PACKAGE_MANAGERS
      && process.file.name !~ "runc*"
  - id: ssl_certificate_tampering_unlink
    description: SSL certificates may have been tampered with
    expression: |-
      (
          (unlink.file.path in [ ~"/etc/ssl/certs/**" ])
          && process.file.path not in PACKAGE_MANAGERS
      )
      && process.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path not in PACKAGE_MANAGERS
      && process.file.name !~ "runc*"
  - id: ssl_certificate_tampering_utimes
    description: SSL certificates may have been tampered with
    expression: |-
      (
          (utimes.file.path in [ ~"/etc/ssl/certs/**" ])
          && process.file.path not in PACKAGE_MANAGERS
      )
      && process.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path != "/usr/sbin/update-ca-certificates"
      && process.ancestors.file.path not in PACKAGE_MANAGERS
      && process.file.name !~ "runc*"
  - id: suspicious_container_client
    description: A container management utility was executed in a container
    expression: exec.file.name in CONTAINER_CLIENTS && container.id != ""
  - id: systemd_modification_chmod
    description: A service may have been modified without authorization
    expression: |-
      (
          (chmod.file.path in SYSTEMD_FOLDERS)
          && process.file.path not in PACKAGE_MANAGERS
      ) && chmod.file.destination.mode != chmod.file.mode
  - id: systemd_modification_chown
    description: A service may have been modified without authorization
    expression: |-
      (
          (chown.file.path in SYSTEMD_FOLDERS)
          && process.file.path not in PACKAGE_MANAGERS
      ) && (chown.file.destination.uid != chown.file.uid || chown.file.destination.gid != chown.file.gid)
  - id: systemd_modification_link
    description: A service may have been modified without authorization
    expression: |-
      (
          (link.file.path in SYSTEMD_FOLDERS
          || link.file.destination.path in SYSTEMD_FOLDERS)
          && process.file.path not in PACKAGE_MANAGERS
      )
  - id: systemd_modification_open
    description: A service may have been modified without authorization
    expression: |-
      (
          open.flags & (OPEN_CREATE_FLAGS) > 0 &&
          (open.file.path in SYSTEMD_FOLDERS)
          && process.file.path not in PACKAGE_MANAGERS
      )
  - id: systemd_modification_rename
    description: A service may have been modified without authorization
    expression: |-
      (
          (rename.file.path in SYSTEMD_FOLDERS
          || rename.file.destination.path in SYSTEMD_FOLDERS)
          && process.file.path not in PACKAGE_MANAGERS
      )
  - id: systemd_modification_unlink
    description: A service may have been modified without authorization
    expression: |-
      (
          (unlink.file.path in SYSTEMD_FOLDERS)
          && process.file.path not in PACKAGE_MANAGERS
      )
  - id: systemd_modification_utimes
    description: A service may have been modified without authorization
    expression: |-
      (
          (utimes.file.path in SYSTEMD_FOLDERS)
          && process.file.path not in PACKAGE_MANAGERS
      )
  - id: tty_shell_in_container
    description: A shell with a TTY was executed in a container
    expression: exec.file.path in SHELLS && process.tty_name != "" && process.container.id != ""
  - id: user_created_tty
    description: A user was created via an interactive session
    expression: exec.file.name in ["useradd", "newusers", "adduser"] && exec.tty_name !="" && process.ancestors.file.path not in PACKAGE_MANAGERS && exec.args_flags not in ["D"]
